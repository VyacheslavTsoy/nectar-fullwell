{% assign relProduct = block.settings.product %}

<script type="application/json" class="bundle-product">
    {
        "active": false,
        "id": {{ relProduct.id | json }},
        "title": {{ block.settings.title | json }},
        "label": {{ block.settings.label | json }},
        "description": {{ block.settings.description | json }},
        "selling_plans": {{ relProduct.selling_plan_groups | json }},
        "variants": [
            {% for variant in relProduct.variants %}
            {
                "id": {{ variant.id | json }},
                "title": {{ variant.title | json }},
                "price": {{ variant.price | json }},
                "quantity": "0",
                "product_title": {{ relProduct.title | json }},
                "image": {{ variant.metafields.custom.variant_image | image_url: width: 460 | json }},
                "selling_plans": [
                    {%- if variant.selling_plan_allocations and variant.selling_plan_allocations.size > 0 -%}
                      {%- for allocation in variant.selling_plan_allocations -%}
                        {
                          "id": {{ allocation.selling_plan.id }},
                          "name": {{ allocation.selling_plan.name | json }},
                          "options": {{ allocation.selling_plan.options | json }}
                        }{%- unless forloop.last -%},{%- endunless -%}
                      {%- endfor -%}
                    {%- endif -%}
                ]
            }{% unless forloop.last %},{% endunless %}
            {% endfor %}
        ]
    }
  </script>

{% schema %}
{
  "name": "Bundle Product",
  "settings": [
    {
      "type": "text",
      "label": "Title",
      "id": "title"
    },
    {
      "type": "text",
      "label": "Label",
      "id": "label"
    },
    {
      "type": "richtext",
      "label": "Description",
      "id": "description"
    },
    {
      "type": "product",
      "label": "Product",
      "id": "product"
    }
  ],
  "presets": [
    {
      "name": "Bundle Product"
    }
  ]
}
{% endschema %}
