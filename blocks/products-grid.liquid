{% assign bst = block.settings %}

<style>
    @media (max-width: 768px) {
        .products-grid__content .product-card:not(:first-child) {
            display: none;
        }
    }
</style>

<div class="products-grid py-[var(--mobile-padding)] lg:py-0" id="{{ block.id }}" style="
    --mobile-padding: {{ bst.mobile_padding | times: 0.1 }}rem;
    --padding: {{ bst.desktop_padding | times: 0.1 }}rem;
    --columns-per-row-desktop: {{ bst.desktop_columns_per_row }};
    --columns-per-row-mobile: {{ bst.mobile_columns_per_row }};
" x-data="productsGrid">
    <div class="btn-group w-full md:w-auto flex gap-2 md:justify-center mb-4 lg:hidden">
        <div class="btn-group__inner py-1.5 px-1.5 flex gap-2 w-full md:w-auto">
            <template x-for="puprose in puproses" :key="puprose">
                <button class="btn-sm w-[33.3%] md:w-auto" x-text="puprose" @click="Alpine.store('productsStorage').activePurpose = puprose; filterByPuprose()" :class="{ 'btn-sm--active': Alpine.store('productsStorage').activePurpose == puprose }"></button>
            </template>
        </div>
    </div>
    <div class="products-grid__content md:py-[var(--padding)] flex flex-col md:grid grid-cols-1 gap-8 lg:grid-cols-[repeat(var(--columns-per-row-desktop),1fr)]">
        {% content_for 'blocks' %}
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('productsGrid', () => ({
            puproses: [],
            activePuprose: null,
          
            collectPurposes() {
              const parentEl = this.$el.closest('.products-grid');
              const products = parentEl.querySelectorAll('.product-card[data-puprose]');
          
              const uniquePurposes = new Set();
          
              products.forEach(product => {
                const puprose = product.dataset.puprose;
                if (puprose) uniquePurposes.add(puprose);
              });
          
              this.puproses = Array.from(uniquePurposes);
            },
          
            filterByPuprose() {
                const parentEl = this.$el.closest('.products-grid');
                const products = parentEl.querySelectorAll('.product-card[data-puprose]');

                if (window.innerWidth > 768) return;

                products.forEach(product => {
                    product.style.display =
                    product.dataset.puprose == Alpine.store('productsStorage').activePurpose ? 'block' : 'none';
                });
            },
          
            init() {
              this.collectPurposes();
              this.activePuprose = this.puproses[0] || null;
          
              this.$watch('activePuprose', () => {
                this.filterByPuprose();
              });
        
              this.filterByPuprose();
            }
          }));
    });
</script>

{% schema %}
{
  "name": "Products Grid",
  "tag": null,
  "settings": [
    {
        "type": "header",
        "content": "Desktop"
    },
    {
        "type": "range",
        "label": "Vertical Padding",
        "id": "desktop_padding",
        "min": 0,
        "max": 200,
        "step": 10,
        "default": 0
    },
    {
        "type": "range",
        "label": "Columns per row",
        "id": "desktop_columns_per_row",
        "min": 1,
        "max": 6,
        "step": 1,
        "default": 3
    },
    {
        "type": "header",
        "content": "Mobile"
    },
    {
        "type": "range",
        "label": "Vertical Padding",
        "id": "mobile_padding",
        "min": 0,
        "max": 200,
        "step": 10,
        "default": 0
    },
    {
        "type": "range",
        "label": "Columns per row",
        "id": "mobile_columns_per_row",
        "min": 1,
        "max": 6,
        "step": 1,
        "default": 1
    }
  ],
  "blocks": [
    {
      "type": "_product-card"
    }
  ],
  "presets": [
    {
      "name": "Products Grid"
    }
  ]
}
{% endschema %}