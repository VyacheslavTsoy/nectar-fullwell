{% render 'entry' with '@/styles/sections/ts-timer.scss' %}

<div class="ts-timer section-{{ section.id }}">
  <div class="ts-timer__wrapper">
    {%- if section.settings.icon != blank -%}
      <div class="ts-timer__icon">
        {{ section.settings.icon | image_url: width: 300 | image_tag }}
      </div>
    {%- endif -%}
    {% if section.settings.title != blank %}
      <p class="ts-timer__title">{{ section.settings.title }}</p>
    {% endif %}
    {% if section.settings.badge != blank %}
      <p class="ts-timer__badge">{{ section.settings.badge }}</p>
    {% endif %}
    {% if section.settings.enable_timer %}
      <div class="ts-timer__block" data-timer>
        <div class="ts-timer__cell" style="display:none;">
          <span data-cell="days">00</span>
          <span>Dys</span>
        </div>
        <span class="ts-timer__divider" style="display:none;"></span>
        <div class="ts-timer__cell">
          <span data-cell="hours">00</span>
          <span>Hrs</span>
        </div>
        <span class="ts-timer__divider"></span>
        <div class="ts-timer__cell">
          <span data-cell="minutes">00</span>
          <span>Min</span>
        </div>
        <span class="ts-timer__divider"></span>
        <div class="ts-timer__cell">
          <span data-cell="seconds">00</span>
          <span>Sec</span>
        </div>
      </div>
    {% endif %}
  </div>
</div>

{% if section.settings.enable_timer %}
  <script>
    (function () {
      const section = document.querySelector(".section-{{ section.id }}");
      const timerElement = section.querySelector("[data-timer]");
      const attributes = ["days","hours","minutes","seconds"];

      function start15MinCountdown() {
        // Таймер всегда отсчитывает ровно 15 минут с момента загрузки
        const endTime = Date.now() + 15 * 60 * 1000;

        function updateTimer() {
          const now = Date.now();
          let timeDiff = endTime - now;

          if (timeDiff <= 0) {
            timeDiff = 0;
            clearInterval(timerInterval);
          }

          const params = {
            days: 0,
            hours: Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)),
            minutes: Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60)),
            seconds: Math.floor((timeDiff % (1000 * 60)) / 1000)
          };
          attributes.forEach(attribute => {
            timerElement.querySelector(`[data-cell="${attribute}"]`).textContent = String(params[attribute]).padStart(2, '0');
          });
        }

        const timerInterval = setInterval(updateTimer, 900);
        updateTimer();
      }

      start15MinCountdown();
    })()
  </script>
{% endif %}

{% schema %}
  {
    "name": "TS Timer",
    "settings": [
      {
        "type": "image_picker",
        "id": "icon",
        "label": "Icon"
      },
      {
        "type": "text",
        "id": "title",
        "label": "Title",
        "default": "Special offer"
      },
      {
        "type": "text",
        "id": "badge",
        "label": "Badge",
        "default": "UP TO 60% OFF"
      },
      {
        "type": "checkbox",
        "id": "enable_timer",
        "label": "Enable timer",
        "default": true,
      },
      {
        "type": "checkbox",
        "id": "enable_daily",
        "label": "Is daily timer",
        "default": true,
      },
      {
        "type": "text",
        "id": "end_date",
        "label": "End date for countdown",
        "info": "Use next time format: dd-mm-yyyy hh:mm"
      }
    ]
  }
{% endschema %}